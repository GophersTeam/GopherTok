# User

## 用户注册

![image-20230822203820409](https://raw.githubusercontent.com/liuxianloveqiqi/Xian-imagehost/main/image/202308222038653.png)

### 流程

首先对用户名和密码进行格式校验，这里使用的是vilidator包

再从redis中查询是否该用户名已经存在，若存在则直接返回用户名已经存在，请重新注册

校验通过后，通过雪花算法生成user_id，将user_id、用户名和进行加盐加密的密码写入kafka，再生成token,然后直接返回信息

kafka消费消息，再加上返回随机图片的url作为头像和背景的url，个性签名也是请求能返回随机个性签名的网站，然后将用户名写入redis，用户信息写入mysql

## 用户登录

首先校验用户名和密码的格式

通过后先从redis查询该用户名是否存在，不存在直接返回错误，

存在后进行密码校验，根据盐值和加密算法校验密码

通过后同样返回token

## 用户信息

首先通过jwt中间件验证身份，通过后获取用户id

根据id获取用户信息，并发调用其他rpc拼接最终的返回信息

## jwt双token

1. `accessToken`的存在，保证了登录态的正常验证，因其过期时间的短暂也保证了帐号的安全性
2. `refreshToekn`的存在，保证了用户（即使是非活跃用户）无需在短时间内进行反复的登陆操作来保证登录态的有效性，同时也保证了活跃用户的登录态可以一直存续而不需要进行重新登录，其反复刷新也防止某些不怀好意的人获取refreshToken后对用户帐号进行动手动脚的操作



## 亮点

* 对于频繁查询的信息，比如用户名利用redis进行缓存
* jwt双token的设计
* 密码进行加盐加密，盐值只有服务器知道，就算黑客知道加密算法也无法暴力破解
* 注册后通过kafka进行异步操作，存入用户信息
* 并发请求生成随机头像，背景图和个性签名的网站
* 并发调用其他服务的rpc，大大减少了响应时间

